<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Etiquetas - V.ESPI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/estilos_odoo.css" />
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="container">
    <h1>üè∑Ô∏è Gesti√≥n de Etiquetas - V.ESPI</h1>
    <div class="modulos-container">
      <div class="modulo" onclick="crearCarpeta()">üìÅ Nueva carpeta</div>
      <div class="modulo" onclick="abrirModal()">‚ûï Nueva etiqueta</div>
    </div>
    <button id="volverBtn" onclick="volver()" style="display:none;">üîô Volver</button>
    <div id="contenido" class="modulos-container"></div>
  </div>

  <div class="modal" id="modalEtiqueta" style="display:none;">
    <div class="modal-content">
      <h3 id="modalTitulo">Crear Etiqueta</h3>
      <input type="text" id="pabilo" placeholder="Pabilo" />
      <input type="text" id="lote" placeholder="Lote" />
      <input type="text" id="mezcla" placeholder="Mezcla" />
      <input type="text" id="grosor" placeholder="Grosor" />
      <input type="text" id="color" placeholder="Color" />
      <input type="text" id="maquina" placeholder="M√°quina" />
      <input type="text" id="encerado" placeholder="Encerado para" />
      <button onclick="guardarEtiqueta()">Guardar</button>
      <button onclick="cerrarModal()">Cancelar</button>
    </div>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBbO6Q2SPmeX0CD2nLXv5AwRfSFZ_3N7Ro",
    authDomain: "etiquetadora-vespi.firebaseapp.com",
    projectId: "etiquetadora-vespi",
    storageBucket: "etiquetadora-vespi.appspot.com",
    messagingSenderId: "714344837885",
    appId: "1:714344837885:web:d80abbd7a0898e1d1ec494"
  };

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const coleccion = "vicente_espi_etiquetas";

  let parentActual = null;
  let parentStack = [];
  let editandoId = null;

  function crearCarpeta() {
    const nombre = prompt("Nombre de carpeta:");
    if (!nombre || nombre.trim() === "") {
      alert("El nombre no puede estar vac√≠o.");
      return;
    }
    db.collection(coleccion).add({
      tipo: "carpeta",
      nombre: nombre.trim(),
      parent: parentActual || null,
      creado: new Date()
    }).then(render).catch(e => {
      console.error("Error al crear carpeta:", e);
      alert("Error al crear carpeta.");
    });
  }

  function abrirModal(etiqueta = null, id = null) {
    document.getElementById("modalEtiqueta").style.display = "flex";
    document.getElementById("modalTitulo").textContent = etiqueta ? "Editar Etiqueta" : "Crear Etiqueta";
    editandoId = id;
    ["pabilo","lote","mezcla","grosor","color","maquina","encerado"].forEach(campo => {
      document.getElementById(campo).value = etiqueta?.campos?.[campo] || "";
    });
  }

  function cerrarModal() {
    document.getElementById("modalEtiqueta").style.display = "none";
    editandoId = null;
  }

  function guardarEtiqueta() {
    const campos = {};
    const lista = ["pabilo", "lote", "mezcla", "grosor", "color", "maquina", "encerado"];
    for (const campo of lista) {
      const val = document.getElementById(campo).value.trim();
      if (!val) {
        alert(`El campo "${campo}" no puede estar vac√≠o.`);
        return;
      }
      campos[campo] = val;
    }

    const doc = {
      tipo: "etiqueta",
      nombre: campos.pabilo,
      parent: parentActual || null,
      creado: new Date(),
      campos
    };

    const ref = editandoId
      ? db.collection(coleccion).doc(editandoId).update(doc)
      : db.collection(coleccion).add(doc);

    ref.then(() => {
      cerrarModal();
      render();
    }).catch(e => {
      console.error("Error al guardar etiqueta:", e);
      alert("Error al guardar etiqueta.");
    });
  }

  function volver() {
    parentActual = parentStack.pop();
    render();
  }

  function render() {
    const contenedor = document.getElementById("contenido");
    contenedor.innerHTML = "";
    document.getElementById("volverBtn").style.display = parentStack.length ? "inline-block" : "none";

    db.collection(coleccion).where("parent", "==", parentActual || null).orderBy("tipo").get()
      .then(snapshot => {
        if (snapshot.empty) {
          contenedor.innerHTML = "<p style='text-align:center;'>üì≠ No hay contenido.</p>";
          return;
        }

        snapshot.forEach(doc => {
          const data = doc.data();
          const div = document.createElement("div");
          div.className = "modulo";

          if (data.tipo === "carpeta") {
            div.textContent = "üìÅ " + data.nombre;
            div.onclick = () => {
              parentStack.push(parentActual);
              parentActual = doc.id;
              render();
            };
          } else {
            div.innerHTML = `
              <strong>${data.campos.pabilo}</strong><br>
              Lote: ${data.campos.lote}<br>
              <button onclick='abrirModal(${JSON.stringify(data)}, "${doc.id}")'>‚úèÔ∏è Editar</button>
              <button onclick='imprimirEtiqueta(${JSON.stringify(data)})'>üñ®Ô∏è Imprimir</button>`;
          }

          contenedor.appendChild(div);
        });
      }).catch(e => {
        console.error("Error al renderizar:", e);
        contenedor.innerHTML = "<p style='color:red;'>‚ùå Error cargando datos.</p>";
      });
  }

  function imprimirEtiqueta(etiqueta) {
    const preview = document.createElement("div");
    preview.className = "print-preview";
    preview.style.display = "block";
    let etiquetasHTML = "";

    for (let i = 0; i < 14; i++) {
      etiquetasHTML += `
        <div style="width: 105mm; height: 42.4mm; float: left; box-sizing: border-box; padding: 10px; font-size: 12px; font-family: Arial, sans-serif; border: 1px dashed #ccc;">
          <strong style="font-size: 16px;">${etiqueta.campos.pabilo}</strong><br>
          Lote: ${etiqueta.campos.lote}<br>
          Mezcla: ${etiqueta.campos.mezcla}<br>
          Grosor: ${etiqueta.campos.grosor}<br>
          Color: ${etiqueta.campos.color}<br>
          M√°quina: ${etiqueta.campos.maquina}<br>
          Encerado para: ${etiqueta.campos.encerado}
        </div>`;
    }

    preview.innerHTML = etiquetasHTML;
    document.body.appendChild(preview);

    const style = document.createElement("style");
    style.textContent = `
      @media print {
        body * { visibility: hidden; }
        .print-preview, .print-preview * { visibility: visible; }
        .print-preview {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          display: flex;
          flex-wrap: wrap;
        }
      }`;
    document.head.appendChild(style);

    setTimeout(() => {
      window.print();
      preview.remove();
      style.remove();
    }, 300);
  }

  render();
</script>
</body>
</html>
