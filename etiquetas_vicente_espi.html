
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Etiquetas - VICENTE ESPI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/estilos_odoo.css">
  <style>
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%%;
      height: 100%%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--card-background-color);
      box-shadow: 0 4px 8px var(--shadow-color);
      border: 1px solid #ddd;

      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%%;
      max-width: 400px;
    }
    .modal input {
      width: 100%%;
      padding: 8px;
      margin: 8px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .etiqueta {
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      margin: 10px;
      box-shadow: 0 2px 6px var(--shadow-color);
      width: 200px;
      cursor: pointer;
    }
    .etiqueta:hover {
      background-color: var(--primary-color);
      color: white;
    }
    .print-preview {
      display: none;
    }
    @media print {
      body * {
        visibility: hidden;
      }
      .print-preview, .print-preview * {
        visibility: visible;
      }
      .print-preview {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%%;
      }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
      .print-preview {
        display: none;
        flex-wrap: wrap;
        width: 210mm;
        height: 297mm;
        padding: 10mm;
        box-sizing: border-box;
      }
      .etiqueta-imprimible {
        width: 50%%;
        height: 42.4mm;
        box-sizing: border-box;
        padding: 5mm;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px dashed #ccc;
        page-break-inside: avoid;
      }
      .etiqueta-celda {
        width: 100%%;
        font-size: 12px;
        line-height: 1.2;
        text-align: left;
      }
      @media print {
        body * {
          visibility: hidden;
        }
        .print-preview, .print-preview * {
          visibility: visible;
        }
        .print-preview {
          position: absolute;
          left: 0;
          top: 0;
          display: flex !important;
        }
      }
    </style>

</head>
<body>
  <div class="container">
    <h1>Gesti√≥n de Etiquetas - VICENTE ESPI</h1>
    <div class="modulos-container">
      <div class="modulo" onclick="crearCarpeta()">
        <h3>NUEVA CARPETA</h3>
        <p>üìÇ</p>
      </div>
      <div class="modulo" onclick="abrirModal()">
        <h3>NUEVA ETIQUETA</h3>
        <p>üè∑Ô∏è</p>
      </div>
    </div>
    <button onclick="volver()" id="volverBtn" style="display:none; margin: 10px 0;">‚Ü© Volver</button>
    <div id="contenido" class="modulos-container"></div>
  </div>

  <div class="modal" id="modalEtiqueta">
    <div class="modal-content">
      <h3 id="modalTitulo">Crear Etiqueta</h3>
      <input type="text" id="pabilo" placeholder="Pabilo">
      <input type="text" id="lote" placeholder="Lote">
      <input type="text" id="mezcla" placeholder="Mezcla">
      <input type="text" id="grosor" placeholder="Grosor">
      <input type="text" id="color" placeholder="Color">
      <input type="text" id="maquina" placeholder="M√°quina">
      <input type="text" id="encerado" placeholder="Encerado para">
      <button onclick="guardarEtiqueta()">Guardar</button>
      <button onclick="cerrarModal()">Cancelar</button>
    </div>
  </div>

  <div class="print-preview" id="printPreview"></div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBbO6Q2SPmeX0CD2nLXv5AwRfSFZ_3N7Ro",
    authDomain: "etiquetadora-vespi.firebaseapp.com",
    projectId: "etiquetadora-vespi",
    storageBucket: "etiquetadora-vespi.firebasestorage.app",
    messagingSenderId: "714344837885",
    appId: "1:714344837885:web:d80abbd7a0898e1d1ec494"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const coleccion = "vicente_espi_etiquetas";

  let parentActual = null;
  let parentStack = [];
  let editandoId = null;

  function crearCarpeta() {
    const nombre = prompt("Nombre de la carpeta:");
    if (!nombre) return;
    db.collection(coleccion).add({
      tipo: "carpeta",
      nombre,
      parent: parentActual || null,
      creado: new Date()
    }).then(render);
  }

  function abrirModal(etiqueta = null, id = null) {
    document.getElementById("modalEtiqueta").style.display = "flex";
    document.getElementById("modalTitulo").textContent = etiqueta ? "Editar Etiqueta" : "Crear Etiqueta";
    editandoId = id;
    const campos = ["pabilo", "lote", "mezcla", "grosor", "color", "maquina", "encerado"];
    campos.forEach(c => {
      document.getElementById(c).value = etiqueta?.campos[c] || "";
    });
  }

  function cerrarModal() {
    document.getElementById("modalEtiqueta").style.display = "none";
    editandoId = null;
  }

  function guardarEtiqueta() {
    const campos = {
      pabilo: document.getElementById("pabilo").value,
      lote: document.getElementById("lote").value,
      mezcla: document.getElementById("mezcla").value,
      grosor: document.getElementById("grosor").value,
      color: document.getElementById("color").value,
      maquina: document.getElementById("maquina").value,
      encerado: document.getElementById("encerado").value
    };
    const doc = {
      tipo: "etiqueta",
      formato: "14",
      nombre: campos.pabilo,
      parent: parentActual || null,
      creado: new Date(),
      campos
    };
    if (editandoId) {
      db.collection(coleccion).doc(editandoId).update(doc).then(() => { render();
        cerrarModal();
        render();
      });
    } else {
      db.collection(coleccion).add(doc).then(() => { render();
        cerrarModal();
        render();
      });
    }
  }

  
  function imprimirEtiqueta(etiqueta) {
    let etiquetasHTML = "";
    for (let i = 0; i < 14; i++) {
      etiquetasHTML += `
        <div class="etiqueta-imprimible">
          <div class="etiqueta-celda">
            <strong style="font-size: 18px;">${etiqueta.campos.pabilo}</strong><br>
            <span>Lote: ${etiqueta.campos.lote}</span><br>
            <span>Mezcla: ${etiqueta.campos.mezcla}</span><br>
            <span>Grosor: ${etiqueta.campos.grosor}</span><br>
            <span>Color: ${etiqueta.campos.color}</span><br>
            <span>M√°quina: ${etiqueta.campos.maquina}</span><br>
            <span>Encerado para: ${etiqueta.campos.encerado}</span>
          </div>
        </div>
      `;
    }
    const preview = document.getElementById("printPreview");
    preview.innerHTML = etiquetasHTML;
    preview.style.display = "block";
    setTimeout(() => window.print(), 300);
  }

  function render() {
    const cont = document.getElementById("contenido");
    cont.innerHTML = "";
    document.getElementById("volverBtn").style.display = parentStack.length > 0 ? "inline-block" : "none";

    db.collection(coleccion)
      .where("parent", "==", parentActual || null)
      .orderBy("tipo")
      .get().then(snapshot => {
        snapshot.forEach(doc => {
          const d = doc.data();
          const div = document.createElement("div");
          div.className = d.tipo === "carpeta" ? "modulo" : "etiqueta";
          if (d.tipo === "carpeta") {
            div.textContent = "üìÅ " + d.nombre;
            div.onclick = () => {
              parentStack.push(parentActual);
              parentActual = doc.id;
              render();
            };
          } else {
            div.innerHTML = `<strong>${d.campos.pabilo}</strong><br>Lote: ${d.campos.lote}<br><button onclick="abrirModal(${JSON.stringify(d).replace(/"/g, '&quot;')}, '${doc.id}')">Editar</button><br><button onclick='imprimirEtiqueta(${JSON.stringify(d).replace(/"/g, '&quot;')})'>üñ®Ô∏è Imprimir</button>`;
          }
          cont.appendChild(div);
        });
      });
  }

  function volver() {
    if (parentStack.length > 0) {
      parentActual = parentStack.pop();
      render();
    }
  }

  render();
</script>
</body>
</html>
